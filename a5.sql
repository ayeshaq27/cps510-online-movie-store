DROP TABLE Review CASCADE CONSTRAINTS;
DROP TABLE Library CASCADE CONSTRAINTS;
DROP TABLE Inventory CASCADE CONSTRAINTS;
DROP TABLE Customer CASCADE CONSTRAINTS;
DROP TABLE Movies CASCADE CONSTRAINTS;
DROP TABLE Customer_Service CASCADE CONSTRAINTS;
DROP TABLE Content_Manager CASCADE CONSTRAINTS;
DROP TABLE Developer CASCADE CONSTRAINTS;

PROMPT === Creating schema objects ===
PROMPT === MOVIES (CATALOG) ===

CREATE TABLE Movies (
    ID  VARCHAR2(10) PRIMARY KEY,
    Movie_Name   VARCHAR2(50) NOT NULL,
    Price   DECIMAL(6,2) DEFAULT 0 CHECK (Price >= 0),
    Genre   VARCHAR2(25),
    Copies  NUMBER(3) DEFAULT 0 CHECK (Copies >=0),
    Avg_Rating  DECIMAL(3,1) CHECK (Avg_Rating BETWEEN 0 AND 5),
    Release_Date    DATE,
    Runtime_Min NUMBER(4) CHECK (Runtime_Min > 0),
    Age_Rating  VARCHAR2(10),
    Language_Code   VARCHAR2(5)
);

PROMPT === CUSTOMER ===
CREATE TABLE Customer (
    Username    VARCHAR2(10) PRIMARY KEY,
    Balance DECIMAL(10,2) DEFAULT 0 CHECK (Balance >=0),
    Password    VARCHAR2(25) NOT NULL,
    First_Name  VARCHAR2(50),
    Last_Name   VARCHAR2(50),
    Age NUMBER(3) CHECK (Age BETWEEN 12 AND 110),
    Email   VARCHAR2(50),
    Phone VARCHAR2(25)
);

PROMPT === INVENTORY (parent for library) ===
CREATE TABLE Inventory (
    Copy_ID VARCHAR2(12) PRIMARY KEY,
    Movie_ID    VARCHAR2(10) NOT NULL,
    Quality VARCHAR2(12) DEFAULT '1080P' NOT NULL CHECK (Quality in ('4K', '1080P', '720P', '480P')),
    Status  VARCHAR2(12) DEFAULT 'AVAILABLE' NOT NULL CHECK (Status in ('AVAILABLE', 'RENTED','RESERVED')),
    FOREIGN KEY (Movie_ID) REFERENCES Movies(ID)
);

PROMPT === Library (rented) ===
CREATE TABLE Library (
    Username    VARCHAR2(10) NOT NULL,
    Movie_ID    VARCHAR2(10) NOT NULL,
    Copy_ID VARCHAR2(12) NOT NULL,
    Start_Date  DATE DEFAULT TRUNC(SYSDATE) NOT NULL,
    Due_Date    DATE GENERATED ALWAYS AS (Start_Date + 7) VIRTUAL,
    Returned_On DATE,
    PRIMARY KEY (Copy_ID, Start_Date),
    FOREIGN KEY (Username) REFERENCES Customer(Username),
    FOREIGN KEY (Movie_ID) REFERENCES Movies(ID),
    FOREIGN KEY (Copy_ID) REFERENCES Inventory(Copy_ID),
    CHECK (Returned_On IS NULL OR Returned_On >= Start_Date)
);


PROMPT === Review ===
CREATE TABLE Review (
    Review_ID   NUMBER(12) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Username VARCHAR2(10) NOT NULL,
    Movie_ID    VARCHAR2(10) NOT NULL,
    Rating  NUMBER(1) NOT NULL CHECK (Rating BETWEEN 1 AND 5),
    Review_text VARCHAR2(50),
    Created_At  DATE DEFAULT SYSDATE NOT NULL,
    FOREIGN KEY (Username) REFERENCES Customer(Username),
    FOREIGN KEY (Movie_ID) REFERENCES Movies(ID),
    UNIQUE (Username, Movie_ID)
);

PROMPT === CUSTOMER SERVICE ===
CREATE TABLE Customer_Service (
    Employee_ID VARCHAR2(10) PRIMARY KEY,
    SHIFT   VARCHAR2(10),
    Password    VARCHAR2(25) NOT NULL,
    EMAIL   VARCHAR2(50)
);

PROMPT === CONTENT MANAGER ===
CREATE TABLE Content_Manager (
    Employee_ID VARCHAR2(10) PRIMARY KEY,
    Movie_To_Change VARCHAR2(10),
    Password    VARCHAR2(25) NOT NULL,
    EMAIL   VARCHAR2(50)
);

PROMPT === DEVELOPER ===
CREATE TABLE Developer (
    Employee_ID VARCHAR2(10) PRIMARY KEY,
    Email   VARCHAR2(50) NOT NULL,
    Password    VARCHAR(72) NOT NULL,
    Specialty   VARCHAR2(50) DEFAULT 'BACKEND' NOT NULL CHECK (Specialty in ('BACKEND', 'FRONTEND')), 
    GitHub  VARCHAR2(80)
);



PROMPT === POPULATING TABLES ===
PROMPT === MOVIES POPULATED ===
INSERT INTO Movies (ID, Movie_Name, Price, Genre, Copies, Avg_Rating, Release_Date, Runtime_Min, Age_Rating, Language_Code) VALUES
('M001','Avengers: Assemble', 3.99, 'Action', 4, 4.3, DATE '2012-05-01', 143, 'PG-13', 'EN');
INSERT INTO Movies VALUES
('M002','Spirited Away',        2.99,'Fantasy', 3, 3.0, DATE '2001-07-20', 125, 'PG',   'JP');
INSERT INTO Movies VALUES
('M003','Parasite',             4.49,'Thriller',3, 2.1, DATE '2019-05-30', 132, 'R',    'KO');
INSERT INTO Movies VALUES
('M004','3 Idiots',             2.49,'Comedy',  2, 4.4, DATE '2009-12-25', 170, 'PG',   'HI');
INSERT INTO Movies VALUES
('M005','The Dark Knight',      3.99,'Action',  4, 5.0, DATE '2008-07-18', 152, 'PG-13','EN');
INSERT INTO Movies VALUES
('M006','Saiyaara',      13.99,'Romance',  2, 3.0, DATE '2025-04-23', 180, 'PG-13','EN');

PROMPT === CUSTOMERS POPULATED ===
INSERT INTO Customer (Username,Balance,Password,First_Name,Last_Name,Age,Email,Phone) VALUES
('alice',  10.00,'passAlice','Alice','Nguyen',   22,'alice@gmail.com','+1-416-555-1001');
INSERT INTO Customer VALUES
('bob',     5.50,'passBob',  'Bob',  'Singh',    25,'bob@gmail.com',  '+1-416-555-1002');
INSERT INTO Customer VALUES
('carol',  20.00,'passCarol','Carol','Perez',    31,'carol@gmail.com','+1-416-555-1003');
INSERT INTO Customer VALUES
('dave',    0.00,'passDave', 'Dave', 'Kim',      19,'dave@gmail.com', '+1-416-555-1004');
INSERT INTO Customer VALUES
('eve',    14.25,'passEve',  'Eve',  'Rahman',   27,'eve@gmail.com',  '+1-416-555-1005');


PROMPT == INVENTORY POPULATED ===
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('AVG01', 'M001','4K','AVAILABLE');  
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('AVG02', 'M001','1080P','RENTED');  
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('AVG03', 'M001','1080P','AVAILABLE');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('AVG04', 'M001','720P','RESERVED'); 


INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('SPI05', 'M002','1080P','AVAILABLE');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('SPI06', 'M002','4K','RENTED');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('SPI07', 'M002','480P','AVAILABLE');


INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('PARA08', 'M003','1080P','AVAILABLE');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('PARA09', 'M003','1080P','RENTED');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('PARA10', 'M003','720P','AVAILABLE');


INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('IDI1', 'M004','1080P','AVAILABLE');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('IDI2', 'M004','720P','AVAILABLE');

INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('DARK1', 'M005','4K','AVAILABLE');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('DARK2', 'M005','1080P','RENTED');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('DARK3', 'M005','1080P','AVAILABLE');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('DARK4', 'M005','480P','AVAILABLE');

INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('SAIY1', 'M006','1080P','AVAILABLE');
INSERT INTO Inventory (Copy_ID, Movie_ID, Quality, Status) VALUES ('SAIY2', 'M006','720P','AVAILABLE');

PROMPT === LIBRARY POPULATED ===
-- Bob is renting Avengers copy AVG02 starting 2025-09-24 (due 2025-10-01)
INSERT INTO Library (Username, Movie_ID, Copy_ID, Start_Date, Returned_On)
VALUES ('bob','M001','AVG02', DATE '2025-09-24', NULL);

-- Alice rented Spirited Away copy SPI06 from 2025-09-10 and returned 2025-09-12
INSERT INTO Library (Username, Movie_ID, Copy_ID, Start_Date, Returned_On)
VALUES ('alice','M002','SPI06', DATE '2025-09-10', DATE '2025-09-12');

-- Dave rented Parasite copy PARA09 on 2025-09-15 (due 2025-09-22), not returned
INSERT INTO Library (Username, Movie_ID, Copy_ID, Start_Date, Returned_On)
VALUES ('dave','M003','PARA09', DATE '2025-09-15', NULL);

-- Eve rented The Dark Knight copy DARK2 on 2025-09-26 (due 2025-10-03), active
INSERT INTO Library (Username, Movie_ID, Copy_ID, Start_Date, Returned_On)
VALUES ('eve','M005','DARK2', DATE '2025-09-26', NULL);

-- Carol rented 3 Idiots copy IDI1 on 2025-09-18 and returned 2025-09-20
INSERT INTO Library (Username, Movie_ID, Copy_ID, Start_Date, Returned_On)
VALUES ('carol','M004','IDI1', DATE '2025-09-18', DATE '2025-09-20');

-- Alice rented Avengers copy AVG03 on 2025-09-01 and returned 2025-09-04
INSERT INTO Library (Username, Movie_ID, Copy_ID, Start_Date, Returned_On)
VALUES ('alice','M001','AVG03', DATE '2025-09-01', DATE '2025-09-04');

PROMPT === POPULATED CONTENT MANAGER ===
INSERT INTO CONTENT_MANAGER(EMPLOYEE_ID, Password, MOVIE_TO_CHANGE, EMAIL) VALUES
('51090', 'charlie123', 'Parasite', 'charlie@gmail.com');
INSERT INTO CONTENT_MANAGER(EMPLOYEE_ID, Password, MOVIE_TO_CHANGE, EMAIL) VALUES
('52091', 'diana456', 'Titanic', 'diana@gmail.com');
INSERT INTO CONTENT_MANAGER(EMPLOYEE_ID, Password, MOVIE_TO_CHANGE, EMAIL) VALUES
('53092', 'edward789', 'Inception', 'edward@gmail.com');

PROMPT === POPULATED CUSTOMER SERVICE ===
INSERT INTO CUSTOMER_SERVICE(EMPLOYEE_ID, Password, SHIFT, EMAIL) VALUES
('60001', 'Josh123', 'Morning', 'Josh@gmail.com');
INSERT INTO CUSTOMER_SERVICE(EMPLOYEE_ID, Password, SHIFT, EMAIL) VALUES
('60002', 'Zach223', 'Afternoon', 'Zach@gmail.com');
INSERT INTO CUSTOMER_SERVICE(EMPLOYEE_ID, Password, SHIFT, EMAIL) VALUES
('60003', 'Pokemon223', 'Night', 'Pokemon@gmail.com');

PROMPT === POPULATED DEVELOPER ===
INSERT INTO DEVELOPER(EMPLOYEE_ID, Password, SPECIALTY, EMAIL, GITHUB) VALUES
('70001', 'Python123', 'BACKEND', 'Jelly@gmail.com', 'https://github.com/zach1');
INSERT INTO DEVELOPER(EMPLOYEE_ID, Password, SPECIALTY, EMAIL, GITHUB) VALUES
('70002', 'HTML123', 'FRONTEND', 'Jaiden@gmail.com', 'https://github.com/Jaiden2');

PROMPT === POPULATED REVIEWS ===
INSERT INTO Review (Username, Movie_ID, Rating, Review_text, Created_At, REVIEW_ID) VALUES
('alice', 'M001', 4, 'Amazing movie with great action scenes!', DATE '2025-09-05', 1132);
INSERT INTO Review (Username, Movie_ID, Rating, Review_text, Created_At, REVIEW_ID) VALUES
('bob', 'M002', 5, 'A beautiful and enchanting film.', DATE '2025-09-15', 2214);

COMMIT;


PROMPT === VIEW A: ACTIVE RENTALS ===
CREATE OR REPLACE VIEW vw_active_rentals AS SELECT
    lib.username,
    c.first_name || ' ' || c.last_name AS customer_name,
    lib.movie_id,
    m.movie_name,
    lib.copy_id,
    lib.start_date,
    lib.due_date
FROM library lib, customer c, movies m
WHERE lib.returned_on IS NULL
    AND c.username = lib.username
    AND m.id = lib.movie_id;
    
PROMPT === VIEW B: Movie Inventory Status ===
CREATE OR REPLACE VIEW vw_movie_inventory_status AS SELECT
    m.id AS movie_id,
    m.movie_name,
    COUNT(inv.copy_id) AS total_copies,
    SUM(CASE WHEN inv.status = 'AVAILABLE' THEN 1 ELSE 0 END) AS available,
    SUM(CASE WHEN inv.status = 'RENTED' THEN 1 ELSE 0 END) AS rented,
    SUM(CASE WHEN inv.status = 'RESERVED' THEN 1 ELSE 0 END) AS reserved
FROM movies m
LEFT JOIN inventory inv ON inv.movie_id = m.id
GROUP BY m.id, m.movie_name;

PROMPT === VIEW C: Review Stats Vs Catalog Rating ===
CREATE OR REPLACE VIEW vw_review_stats AS SELECT
    m.id AS movie_id,
    m.movie_name,
    m.avg_rating AS catalog_avg_rating,
    COUNT(r.review_id) AS review_count,
    ROUND(AVG(r.rating), 2) AS avg_user_rating
FROM movies m
LEFT JOIN review r ON r.movie_id = m.id
GROUP BY m.id, m.movie_name, m.avg_rating;

PROMPT === VIEW D: Customer Rental Summary ===
CREATE OR REPLACE VIEW vw_customer_rental_summary AS SELECT
    c.username,
    c.first_name || ' ' || c.last_name AS customer_name,
    c.email,
    c.balance,
    COUNT(lib.copy_id) AS total_rentals,
    SUM(CASE WHEN lib.returned_on IS NULL THEN 1 ELSE 0 END) AS active_rentals,
    MAX(lib.start_date) AS last_rental_start
FROM customer c
LEFT JOIN library lib ON lib.username = c.username
GROUP BY c.username, c.first_name, c.last_name, c.email, c.balance;

PROMPT === REVIEWS ===
CREATE OR REPLACE VIEW vw_customer_reviews AS SELECT
    c.username,
    c.first_name || ' ' || c.last_name AS customer_name,
    r.movie_id,
    m.movie_name,
    r.rating,
    r.review_text AS review,
    r.created_at AS published
FROM customer c, review r, movies m
WHERE c.username = r.username
AND m.id = r.movie_id;

SET PAGESIZE 200
SET LINESIZE 180
SET TRIMSPOOL ON

COLUMN customer_name   HEADING 'CUSTOMER'       FORMAT A22
COLUMN movie_name      HEADING 'MOVIE'          FORMAT A28
COLUMN copy_id         HEADING 'COPY'           FORMAT A8
COLUMN start_date      HEADING 'START'          FORMAT A12
COLUMN due_date        HEADING 'DUE'            FORMAT A12
COLUMN available       HEADING 'AVAILABLE'
COLUMN rented          HEADING 'RENTED'
COLUMN reserved        HEADING 'RESVD'

PROMPT === ACTIVE RENTALS ===
SELECT * FROM vw_active_rentals ORDER BY due_date, movie_name;

PROMPT === MOVIE INVENTORY STATUS ===
SELECT * FROM vw_movie_inventory_status ORDER BY movie_name;

PROMPT === REVIEW STATS ===
SELECT * FROM vw_review_stats ORDER BY review_count DESC, movie_name;

PROMPT === REVIEWS ===
SELECT * FROM vw_customer_reviews ORDER BY published DESC, movie_name;

PROMPT === CUSTOMER RENTAL SUMMARY ===
SELECT * FROM vw_customer_rental_summary ORDER BY active_rentals DESC, total_rentals DESC, customer_name;




PROMPT === USERS RENTING M003 ===
SELECT DISTINCT 
    lib.username, 
    c.username || ' '|| c.last_name AS customer_name,
    m.movie_name
FROM library lib, customer c, movies m
WHERE c.username = lib.username
AND m.id = lib.movie_id
AND lib.movie_id = 'M003'
AND lib.returned_on IS NULL
ORDER BY customer_name;


PROMPT === RENTED COPIES WITH QUALITIES ===
SELECT
    lib.copy_id,
    lib.movie_id,
    m.movie_name,
    inv.quality,
    lib.username,
    lib.start_date,
    lib.due_date
FROM library lib, movies m, inventory inv
WHERE inv.copy_id = lib.copy_id
AND m.id = lib.movie_id
AND lib.returned_on IS NULL
ORDER BY m.movie_name, lib.copy_id;

PROMPT === TOP-RATED MOVIES ===
SELECT m.genre, m.movie_name, m.avg_rating
FROM movies m
WHERE m.avg_rating = (SELECT MAX(m2.avg_rating) FROM movies m2 WHERE m2.genre = m.genre)
ORDER BY m.genre, m.avg_rating DESC;

PROMPT === MOVIE RENTALS WITHOUT CUSTOMER REVIEWS ===
SELECT DISTINCT m.id AS movie_id, m.movie_name
FROM movies m, library lib
WHERE lib.movie_id = m.id
AND NOT EXISTS ( SELECT 1 FROM review r WHERE r.movie_id = m.id)
ORDER BY m.movie_name;

PROMPT === Movies starting with THE ===
SELECT m.id, m.movie_name
FROM movies m
WHERE m.movie_name LIKE 'The%'
ORDER BY m.movie_name;

PROMPT === Movies released between 2015 to 2020 ===
SELECT m.id, m.movie_name, m.release_date
FROM movies m
WHERE m.release_date BETWEEN DATE '2015-01-01' AND DATE '2020-12-31'
ORDER BY m.release_date, m.movie_name;

PROMPT === Movies never rented ===
SELECT m.id, m.movie_name
FROM movies m
WHERE m.id NOT IN (SELECT lib.movie_id FROM library lib)
ORDER BY m.movie_name;
